<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e0f7fa, #ffffff);
    }
    header {
      background-color: #26a69a;
      color: white;
      text-align: center;
      padding: 20px;
    }
    #map {
      width: 100%;
      height: 400px;
    }
    .content {
      padding: 20px;
    }
    #chartContainer {
      max-width: 600px;
      margin: 0 auto;
    }
    #recommendations {
      margin-top: 20px;
      background: #f1f8e9;
      padding: 15px;
      border-left: 5px solid #66bb6a;
    }
    #bgToggle {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #26a69a;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h1>üå¨Ô∏è –Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è</h1>
    <p>–Ü–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞, –≥—Ä–∞—Ñ—ñ–∫ —Ç–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó</p>
  </header>

  <div id="map"></div>

  <div class="content">
    <div id="chartContainer">
      <canvas id="airChart"></canvas>
    </div>

    <div id="recommendations">
      <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:</h3>
      <ul id="adviceList"></ul>
    </div>

    <button id="bgToggle">üé® –ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ–Ω</button>
  </div>

  <script>
    let map;

    function initMap() {
      const kyiv = { lat: 50.4501, lng: 30.5234 };
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 10,
        center: kyiv,
      });

      navigator.geolocation.getCurrentPosition(
        pos => {
          const userPos = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
          };

          map.setCenter(userPos);
          new google.maps.Marker({ position: userPos, map, title: "–í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è" });

          const circle = new google.maps.Circle({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map,
            center: userPos,
            radius: 3000,
          });

          fetchAirQuality(userPos.lat, userPos.lng);
        },
        err => {
          alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è. –î–∞–Ω—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ñ.");
          fetchAirQuality(50.4501, 30.5234);
        }
      );
    }

    async function fetchAirQuality(lat, lon) {
      const apiKey = "c0a820cfc0cc46cc51e67536bf08f5e3";
      const url = `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${apiKey}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (data && data.list && data.list.length > 0) {
          const aqi = data.list[0].main.aqi;
          const components = data.list[0].components;

          new Chart(document.getElementById("airChart").getContext("2d"), {
            type: "bar",
            data: {
              labels: ["PM2.5", "PM10", "O‚ÇÉ", "NO‚ÇÇ", "SO‚ÇÇ", "CO"],
              datasets: [{
                label: "Œºg/m¬≥",
                data: [
                  components.pm2_5, components.pm10, components.o3,
                  components.no2, components.so2, components.co
                ],
                backgroundColor: "#26a69a"
              }]
            },
            options: {
              responsive: true,
              scales: { y: { beginAtZero: true } }
            }
          });

          const recommendations = [
            "–£–Ω–∏–∫–∞–π—Ç–µ –ø—Ä–æ–≥—É–ª—è–Ω–æ–∫ –ø–æ–±–ª–∏–∑—É –¥–æ—Ä—ñ–≥.",
            "–¢—Ä–∏–º–∞–π—Ç–µ –≤—ñ–∫–Ω–∞ –∑–∞—á–∏–Ω–µ–Ω–∏–º–∏ –ø—Ä–∏ –≤–∏—Å–æ–∫–æ–º—É –∑–∞–±—Ä—É–¥–Ω–µ–Ω–Ω—ñ.",
            "–ù–æ—Å—ñ—Ç—å –º–∞—Å–∫—É, —è–∫—â–æ –≤—ñ–¥—á—É–≤–∞—î—Ç–µ —É—Ç—Ä—É–¥–Ω–µ–Ω–µ –¥–∏—Ö–∞–Ω–Ω—è."
          ];
          document.getElementById("adviceList").innerHTML = recommendations.map(r => `<li>${r}</li>`).join("");

          // [6] –ù–∞–¥—Å–∏–ª–∞–Ω–Ω—è –≤ MongoDB (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
          /*
          await fetch("https://eco-monitoring-backend-production.up.railway.app/api/airdata", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat, lon, aqi, components })
          });
          */

        } else {
          alert("–î–∞–Ω—ñ –ø—Ä–æ —è–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è –≤–∞—à–æ–≥–æ —Ä–µ–≥—ñ–æ–Ω—É.");
        }

      } catch (err) {
        console.error("–ü–æ–º–∏–ª–∫–∞ API:", err);
      }
    }

    // üé® –ó–º—ñ–Ω–∞ —Ñ–æ–Ω—É
    const bgToggle = document.getElementById("bgToggle");
    let isDefault = true;
    bgToggle.addEventListener("click", () => {
      document.body.style.background = isDefault
        ? "linear-gradient(135deg, #ffecb3, #ffe082)"
        : "linear-gradient(135deg, #e0f7fa, #ffffff)";
      isDefault = !isDefault;
    });
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAOib_11QyNZYlK2wIjsBEM2fWJf6CYiF0&callback=initMap" async defer></script>
</body>
</html>

